version: '3.8'

services:
  # 语音服务
  voice-service:
    container_name: voice-service-container
    build:
      context: ../../  # 从项目根目录构建
      dockerfile: ./services/voice-service/Dockerfile
    image: voice-service:latest
    environment:
      # 服务器配置
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=7701
      # 应用配置
      - APP_NAME=Voice Service
      - APP_VERSION=1.0.0
      - APP_ENVIRONMENT=development
      # 安全配置
      - SECURITY_ALLOWED_HOSTS=localhost,127.0.0.1,*.local,*
      - SECURITY_CORS_ORIGINS=http://localhost:3000,https://localhost:3000,http://127.0.0.1:3000,*
      # 语音服务功能开关
      - FUNASR_DISABLE_LM=False
      - VOICE_DISABLE_LLM=True
      - VOICE_ALWAYS_SAVE_SAMPLE=false
      - VOICE_REQUIRE_WAKE=false
      # FunASR配置
      - FUNASR_HOST=localhost
      - FUNASR_PORT=10095
      - LOG_TO_CONSOLE_ONLY=true
      # ModelScope 缓存路径（FunASR 自动下载的模型会缓存到这里）
      - MODELSCOPE_CACHE=/root/.cache/modelscope
    ports:
      - "7701:7701"
    volumes:
      - ../../config:/config:ro
      - ../../logs:/logs
      - ../../generated:/workspace/voice-service/generated
      # 挂载模型目录，确保容器重启后模型文件仍然存在
      - ../../services/voice-service/app/services/models:/workspace/models:ro
      # 挂载 ModelScope 缓存目录，确保 FunASR 自动下载的模型在容器重启后仍然存在
      # 从日志确认：模型缓存路径为 /root/.cache/modelscope
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://127.0.0.1:7701/health', timeout=10)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

